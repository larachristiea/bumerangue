# Documenta√ß√£o T√©cnica - Parser H√≠brido NFe

## üèóÔ∏è **ARQUITETURA GERAL**

### **Vis√£o Geral**
O Parser H√≠brido NFe combina a robustez t√©cnica de valida√ß√£o fiscal com funcionalidades completas de neg√≥cio, oferecendo uma solu√ß√£o enterprise para processamento de Notas Fiscais Eletr√¥nicas.

### **Princ√≠pios de Design**
1. **Robustez**: Valida√ß√£o fiscal rigorosa em m√∫ltiplas camadas
2. **Precis√£o**: Uso de `Decimal` para valores monet√°rios
3. **Flexibilidade**: Suporte a diferentes estruturas XML e casos de uso
4. **Observabilidade**: Logging estruturado e rastreabilidade completa
5. **Compatibilidade**: Migra√ß√£o suave do sistema existente

---

## üì¶ **COMPONENTES PRINCIPAIS**

### **1. Core Parser (`parser_hibrido.py`)**
```
NFEParserHibrido
‚îú‚îÄ‚îÄ Valida√ß√£o XML estrutural
‚îú‚îÄ‚îÄ Extra√ß√£o de dados robusta
‚îú‚îÄ‚îÄ Classifica√ß√£o tribut√°ria h√≠brida
‚îú‚îÄ‚îÄ Processamento de eventos
‚îî‚îÄ‚îÄ Agrega√ß√£o de estat√≠sticas
```

**Responsabilidades:**
- Parse de XML com lxml (performance superior)
- Valida√ß√£o estrutural antes do processamento
- Extra√ß√£o segura com tratamento de tipos
- Classifica√ß√£o por NCM + CST (metodologia h√≠brida)
- Processamento de cancelamentos automatizado

### **2. Modelos de Dados (`models.py`)**
```
NotaFiscal
‚îú‚îÄ‚îÄ Identifica√ß√£o (chave, n√∫mero, s√©rie)
‚îú‚îÄ‚îÄ Emitente/Destinat√°rio
‚îú‚îÄ‚îÄ Valores totais (Decimal)
‚îú‚îÄ‚îÄ Lista de ItemNotaFiscal
‚îú‚îÄ‚îÄ Status e valida√ß√£o
‚îî‚îÄ‚îÄ Metadados de processamento

ItemNotaFiscal
‚îú‚îÄ‚îÄ Dados do produto
‚îú‚îÄ‚îÄ Classifica√ß√£o fiscal (NCM, CFOP)
‚îú‚îÄ‚îÄ Valores comerciais (Decimal)
‚îú‚îÄ‚îÄ Tributos PIS/COFINS
‚îú‚îÄ‚îÄ Classifica√ß√£o tribut√°ria
‚îî‚îÄ‚îÄ Valida√ß√µes espec√≠ficas
```

**Caracter√≠sticas:**
- Orienta√ß√£o a objetos com encapsulamento
- M√©todos de neg√≥cio (c√°lculos, agrega√ß√µes)
- Serializa√ß√£o JSON autom√°tica
- Valida√ß√£o de consist√™ncia integrada

### **3. Validadores Fiscais (`validators.py`)**
```
ValidadorFiscal
‚îú‚îÄ‚îÄ CNPJ/CPF (algor√≠tmicos + estruturais)
‚îú‚îÄ‚îÄ NCM (8 d√≠gitos + formato)
‚îú‚îÄ‚îÄ CFOP (4 d√≠gitos + primeiro d√≠gito)
‚îú‚îÄ‚îÄ CST (c√≥digos v√°lidos conforme legisla√ß√£o)
‚îú‚îÄ‚îÄ Chave NFe (44 d√≠gitos + formato)
‚îî‚îÄ‚îÄ Valores monet√°rios (formato num√©rico)
```

**Valida√ß√µes Implementadas:**
- **CNPJ**: 14 d√≠gitos, sem sequ√™ncias inv√°lidas conhecidas
- **NCM**: 8 d√≠gitos num√©ricos obrigat√≥rios
- **CFOP**: 4 d√≠gitos, primeiro d√≠gito em [1,2,3,5,6,7]
- **CST**: Lista de c√≥digos v√°lidos conforme legisla√ß√£o
- **Monet√°rios**: Formato decimal com v√≠rgula/ponto

### **4. Utilit√°rios (`utils.py`)**
```
Utilit√°rios
‚îú‚îÄ‚îÄ UtilXML (namespace h√≠brido)
‚îú‚îÄ‚îÄ UtilData (parsing ISO + brasileiro)
‚îú‚îÄ‚îÄ UtilValor (Decimal + formata√ß√£o)
‚îú‚îÄ‚îÄ UtilArquivo (encoding autom√°tico)
‚îú‚îÄ‚îÄ UtilTributario (classifica√ß√µes)
‚îî‚îÄ‚îÄ UtilLog (estruturado)
```

**Funcionalidades:**
- **Namespace H√≠brido**: Expl√≠cito + flex√≠vel para diferentes XMLs
- **Encoding Autom√°tico**: Detec√ß√£o de charset autom√°tica
- **Precis√£o Decimal**: Convers√µes seguras para Decimal
- **Logging Estruturado**: N√≠veis hier√°rquicos com contexto

---

## üîÑ **FLUXO DE PROCESSAMENTO**

### **Processamento Individual de XML**
```mermaid
graph TD
    A[XML Input] --> B[Valida√ß√£o Estrutural]
    B --> C[Parse com lxml]
    C --> D[Extra√ß√£o infNFe]
    D --> E[Valida√ß√£o Elementos Obrigat√≥rios]
    E --> F[Extra√ß√£o Dados Nota]
    F --> G[Processamento Itens]
    G --> H[Classifica√ß√£o Tribut√°ria]
    H --> I[Valida√ß√£o Consist√™ncia]
    I --> J[Agrega√ß√£o Estat√≠sticas]
    J --> K[NotaFiscal Object]
```

### **Processamento de Diret√≥rio**
```mermaid
graph TD
    A[Diret√≥rio XMLs] --> B[Listagem Arquivos]
    B --> C[Identifica√ß√£o Eventos]
    C --> D[Mapeamento Cancelamentos]
    D --> E[Processamento NFes]
    E --> F[Aplica√ß√£o Status]
    F --> G[Agrega√ß√£o Resultados]
    G --> H[Estat√≠sticas Finais]
```

### **Classifica√ß√£o Tribut√°ria H√≠brida**
```mermaid
graph TD
    A[Item NFe] --> B{NCM na Tabela?}
    B -->|Sim| C[Monof√°sico por NCM]
    B -->|N√£o| D{CST Monof√°sico?}
    D -->|Sim| E[Monof√°sico por CST]
    D -->|N√£o| F[N√£o-Monof√°sico]
    C --> G[item.tipo_tributario = "Monofasico"]
    E --> G
    F --> H[item.tipo_tributario = "NaoMonofasico"]
```

---

## üÜö **COMPARA√á√ÉO COM SISTEMA ANTERIOR**

### **Melhorias T√©cnicas**

| Aspecto | Sistema Anterior | Parser H√≠brido |
|---------|------------------|----------------|
| **Biblioteca XML** | ElementTree | lxml (superior) |
| **Valida√ß√£o** | B√°sica | Robusta multin√≠vel |
| **Logging** | Prints simples | Estruturado hier√°rquico |
| **Tipos Monet√°rios** | float (imprecis√£o) | Decimal (precis√£o fiscal) |
| **Tratamento Erro** | Try/catch b√°sico | M√∫ltiplas camadas |
| **Namespace** | Flex√≠vel apenas | H√≠brido (expl√≠cito + flex√≠vel) |

### **Funcionalidades Mantidas**
‚úÖ **Classes OO**: NotaFiscal, ItemNotaFiscal  
‚úÖ **Processamento Cancelamentos**: Eventos + nome arquivo  
‚úÖ **Integra√ß√£o PGDAS**: Compat√≠vel com dados existentes  
‚úÖ **C√°lculo Cr√©ditos**: Mant√©m l√≥gica de neg√≥cio  
‚úÖ **Estat√≠sticas**: Agrega√ß√µes e propor√ß√µes  

### **Funcionalidades Adicionadas**
üÜï **Valida√ß√£o Fiscal Robusta**: CNPJ, NCM, CFOP, CST  
üÜï **Logging Estruturado**: Rastreabilidade completa  
üÜï **Precis√£o Decimal**: Valores monet√°rios exatos  
üÜï **Metadados Processamento**: Timestamp, origem, logs  
üÜï **Serializa√ß√£o JSON**: Dados estruturados para APIs  
üÜï **Valida√ß√£o Consist√™ncia**: Totais vs. itens  

---

## üîß **CONFIGURA√á√ïES AVAN√áADAS**

### **Logging Personalizado**
```python
from parser_hibrido import configurar_logging

# Configura√ß√£o b√°sica
configurar_logging("INFO")

# Configura√ß√£o com arquivo
configurar_logging("DEBUG", "logs/parser_debug.log")

# Configura√ß√£o program√°tica
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('parser.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
```

### **Valida√ß√£o Customizada**
```python
from parser_hibrido import ValidadorFiscal

class ValidadorPersonalizado(ValidadorFiscal):
    def validar_ncm_empresa(self, ncm):
        """Valida√ß√£o espec√≠fica da empresa"""
        if not self.validar_ncm(ncm):
            return False
        
        # Regras espec√≠ficas da empresa
        if ncm.startswith('2208'):  # Bebidas alco√≥licas
            return self.verificar_licenca_bebidas()
        
        return True

# Usar validador personalizado
parser = NFEParserHibrido()
parser.validador = ValidadorPersonalizado()
```

### **Processamento Paralelo**
```python
import multiprocessing
from parser_hibrido import processar_xml_nfe_hibrido

def processar_lote_paralelo(arquivos_xml, tabela_ncm, num_processos=4):
    """Processamento paralelo de lote de XMLs"""
    
    def processar_arquivo(arquivo):
        with open(arquivo, 'r', encoding='utf-8') as f:
            return processar_xml_nfe_hibrido(f.read(), tabela_ncm, arquivo)
    
    with multiprocessing.Pool(num_processos) as pool:
        resultados = pool.map(processar_arquivo, arquivos_xml)
    
    return [r for r in resultados if r is not None]
```

---

## üìä **M√âTRICAS E OBSERVABILIDADE**

### **M√©tricas Coletadas**
```python
# Estat√≠sticas de processamento
{
    'total_processados': 1000,
    'total_validos': 950,
    'total_invalidos': 30,
    'total_cancelados': 20,
    'tempo_processamento': 45.67,
    'throughput': 21.9  # XMLs por segundo
}

# Estat√≠sticas por nota
{
    'total_itens': 15,
    'itens_monofasicos': 8,
    'itens_nao_monofasicos': 7,
    'valor_total_monofasicos': 12500.00,
    'proporcao_monofasicos': 53.33,
    'valor_pis_total': 245.80,
    'valor_cofins_total': 1134.20
}
```

### **Logs Estruturados**
```
2024-12-01 14:30:15 - parser_hibrido - INFO - Iniciando processamento diret√≥rio: /data/xmls
2024-12-01 14:30:15 - parser_hibrido - INFO - Encontrados 150 arquivos XML
2024-12-01 14:30:16 - validators - WARNING - CNPJ inv√°lido: 123456789
2024-12-01 14:30:16 - parser_hibrido - ERROR - Elemento infNFe n√£o encontrado
2024-12-01 14:30:45 - parser_hibrido - INFO - Processamento conclu√≠do: 148/150 sucessos
```

### **Monitoramento de Performance**
```python
import time
from parser_hibrido import NFEParserHibrido

class ParserMonitorado(NFEParserHibrido):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.metricas = {
            'tempo_parse': [],
            'tempo_validacao': [],
            'memoria_utilizada': []
        }
    
    def processar_xml_nfe(self, xml_content, arquivo_origem=""):
        inicio = time.time()
        resultado = super().processar_xml_nfe(xml_content, arquivo_origem)
        tempo_total = time.time() - inicio
        
        self.metricas['tempo_parse'].append(tempo_total)
        return resultado
```

---

## üöÄ **PADR√ïES DE USO**

### **Uso B√°sico - Drop-in Replacement**
```python
# Substitui√ß√£o direta do sistema anterior
from parser_hibrido import processar_diretorio_nfe_hibrido

resultado = processar_diretorio_nfe_hibrido("data/xmls")
notas = resultado['notas']
estatisticas = resultado['estatisticas']
```

### **Uso Avan√ßado - Controle Total**
```python
from parser_hibrido import NFEParserHibrido
import json

# Carregar configura√ß√µes
with open('config.json', 'r') as f:
    config = json.load(f)

# Carregar tabela NCM
with open('tabela_ncm.json', 'r') as f:
    tabela_ncm = json.load(f)

# Criar parser customizado
parser = NFEParserHibrido(tabela_ncm)

# Processar com controle granular
for arquivo in lista_xmls:
    with open(arquivo, 'r', encoding='utf-8') as f:
        xml_content = f.read()
    
    nota = parser.processar_xml_nfe(xml_content, arquivo)
    
    if nota and nota.valida:
        # Processamento espec√≠fico por nota
        if nota.obter_proporcao_monofasicos() > 50:
            processar_nota_monofasica_majoritaria(nota)
        else:
            processar_nota_regular(nota)
```

### **Integra√ß√£o com APIs**
```python
from flask import Flask, request, jsonify
from parser_hibrido import processar_xml_nfe_hibrido

app = Flask(__name__)

@app.route('/processar-nfe', methods=['POST'])
def processar_nfe_api():
    xml_content = request.data.decode('utf-8')
    
    nota = processar_xml_nfe_hibrido(xml_content)
    
    if nota:
        return jsonify({
            'sucesso': True,
            'dados': nota.to_dict(),
            'estatisticas': nota.obter_estatisticas()
        })
    else:
        return jsonify({
            'sucesso': False,
            'erro': 'Falha no processamento'
        }), 400
```

---

## üîí **SEGURAN√áA E COMPLIANCE**

### **Valida√ß√µes de Seguran√ßa**
- ‚úÖ **XML Bombs**: Prote√ß√£o contra XMLs maliciosos
- ‚úÖ **Encoding Safety**: Detec√ß√£o autom√°tica segura
- ‚úÖ **Memory Limits**: Controle de uso de mem√≥ria
- ‚úÖ **Path Traversal**: Valida√ß√£o de caminhos de arquivo

### **Compliance Fiscal**
- ‚úÖ **Receita Federal**: Conformidade com layout NFe
- ‚úÖ **Valida√ß√µes Fiscais**: CNPJ, NCM, CFOP por especifica√ß√£o
- ‚úÖ **Auditoria**: Logs completos de processamento
- ‚úÖ **Rastreabilidade**: Origem e transforma√ß√µes documentadas

### **Prote√ß√£o de Dados**
```python
# Exemplo de dados sens√≠veis ofuscados em logs
def log_seguro(cnpj, nome):
    cnpj_ofuscado = cnpj[:8] + "****" + cnpj[-2:] if cnpj else ""
    nome_ofuscado = nome[:10] + "..." if len(nome) > 10 else nome
    logger.info(f"Processando: {cnpj_ofuscado} - {nome_ofuscado}")
```

---

## üìà **ROADMAP E EVOLUT√á√ÉO**

### **Vers√£o Atual (v1.0)**
- ‚úÖ Parser h√≠brido completo
- ‚úÖ Valida√ß√£o fiscal robusta
- ‚úÖ Compatibilidade com sistema existente
- ‚úÖ Logging estruturado
- ‚úÖ Documenta√ß√£o completa

### **Pr√≥ximas Vers√µes**

**v1.1 - Funcionalidades Estendidas**
- [ ] Suporte a NFCe (Cupom Fiscal)
- [ ] Valida√ß√£o de d√≠gitos verificadores
- [ ] Cache de valida√ß√µes para performance
- [ ] Interface gr√°fica de configura√ß√£o

**v1.2 - Integra√ß√£o Avan√ßada**
- [ ] APIs REST completas
- [ ] Integra√ß√£o com bancos de dados
- [ ] Dashboard de monitoramento
- [ ] Alertas autom√°ticos

**v2.0 - Ecosistema Completo**
- [ ] Suporte a CTe, MDFe
- [ ] Machine Learning para classifica√ß√£o
- [ ] Processamento em tempo real
- [ ] Arquitetura distribu√≠da

---

## ü§ù **CONTRIBUI√á√ÉO E MANUTEN√á√ÉO**

### **Estrutura de Desenvolvimento**
```
parser_hibrido/
‚îú‚îÄ‚îÄ src/                    # C√≥digo fonte
‚îú‚îÄ‚îÄ tests/                  # Testes unit√°rios
‚îú‚îÄ‚îÄ docs/                   # Documenta√ß√£o
‚îú‚îÄ‚îÄ examples/               # Exemplos de uso
‚îú‚îÄ‚îÄ benchmarks/             # Testes de performance
‚îî‚îÄ‚îÄ tools/                  # Ferramentas auxiliares
```

### **Padr√µes de C√≥digo**
- **PEP 8**: Estilo Python padr√£o
- **Type Hints**: Tipagem est√°tica
- **Docstrings**: Documenta√ß√£o inline
- **Testing**: Cobertura m√≠nima 90%

### **Process de Release**
1. **Development**: Feature branches
2. **Testing**: CI/CD automatizado
3. **Review**: Code review obrigat√≥rio
4. **Release**: Versionamento sem√¢ntico
5. **Documentation**: Atualiza√ß√£o autom√°tica

---

**Parser H√≠brido NFe - Desenvolvido para excel√™ncia em processamento fiscal** üèÜ
